<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ä¸­åŒ»æ™ºèƒ½è¾¨è¯ç³»ç»Ÿ (APIç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 40px; font-weight: 600; }
        .section { margin-bottom: 35px; padding: 25px; border: 1px solid #e1e4e8; border-radius: 10px; background-color: #fafbfc; }
        .section h2 { font-size: 20px; margin-top: 0; border-left: 5px solid #007bff; padding-left: 15px; color: #2c3e50; }
        
        /* è¾“å…¥åŒºåŸŸæ ·å¼ */
        .input-group { margin-top: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input[type="text"], textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        textarea { height: 100px; resize: vertical; }
        
        .note { font-size: 12px; color: #e67e22; margin-top: 5px; background: #fff8e1; padding: 8px; border-radius: 4px; }

        /* é¢„è§ˆå›¾ */
        .preview-img { max-width: 200px; max-height: 200px; margin-top: 10px; border-radius: 6px; border: 2px solid #eee; display: none; }

        /* æŒ‰é’® */
        .btn-submit { display: block; width: 100%; padding: 16px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-submit:hover { background-color: #0056b3; }
        .btn-submit:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* ç»“æœå±•ç¤º */
        #result-area { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; display: none; }
        .result-box { background: #e8f4fd; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #2196F3; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-family: Consolas, monospace; font-size: 13px; color: #444; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¥ AI ä¸­åŒ»è¾…åŠ©è¯Šæ–­ç³»ç»Ÿ</h1>
    
    <div class="section" style="border-left-color: #ff9800;">
        <h2>0. API é…ç½® (å¿…å¡«)</h2>
        <div class="input-group">
            <label>AppID (å¼€æ”¾å¹³å°æä¾›çš„ID):</label>
            <input type="text" id="api_appid" placeholder="è¯·è¾“å…¥ä½ çš„ AppID" value="">
        </div>
        <div class="input-group">
            <label>AppKey (ç”¨äºç”Ÿæˆç­¾å):</label>
            <input type="text" id="api_appkey" placeholder="è¯·è¾“å…¥ä½ çš„ AppKey" value="">
        </div>
    </div>

    <div class="section">
        <h2>1. èˆŒè¯Šåˆ†æ</h2>
        <div class="input-group">
            <label>èˆŒè±¡å›¾ç‰‡ URL åœ°å€ (APIè¦æ±‚å¿…é¡»æ˜¯ç½‘ç»œåœ°å€):</label>
            <input type="text" id="tongueUrl" value="https://img0.baidu.com/it/u=3028604889,2985420658&fm=253&fmt=auto&app=138&f=JPEG?w=667&h=500" oninput="updatePreview('tongueUrl', 'tonguePreview')">
            <div class="note">âš ï¸ æ³¨æ„ï¼šæ­¤APIä¸æ”¯æŒç›´æ¥ä¸Šä¼ æœ¬åœ°æ–‡ä»¶ã€‚è¯·å…ˆå°†å›¾ç‰‡ä¸Šä¼ åˆ°å›¾åºŠ(å¦‚imgur)è·å–é“¾æ¥ï¼Œæˆ–ä½¿ç”¨ä¸Šæ–¹é»˜è®¤æµ‹è¯•é“¾æ¥ã€‚</div>
            <img id="tonguePreview" src="https://img0.baidu.com/it/u=3028604889,2985420658&fm=253&fmt=auto&app=138&f=JPEG?w=667&h=500" class="preview-img" style="display:block">
        </div>
    </div>

    <div class="section">
        <h2>2. é¢è¯Šåˆ†æ</h2>
        <div class="input-group">
            <label>é¢éƒ¨å›¾ç‰‡ URL åœ°å€:</label>
            <input type="text" id="faceUrl" placeholder="è¯·è¾“å…¥é¢éƒ¨å›¾ç‰‡URL..." oninput="updatePreview('faceUrl', 'facePreview')">
            <img id="facePreview" class="preview-img">
        </div>
    </div>

    <div class="section">
        <h2>3. ç—‡çŠ¶æè¿°</h2>
        <textarea id="symptoms" placeholder="è¯·è¾“å…¥ä¸»è¦ç—‡çŠ¶ï¼ˆä¾‹å¦‚ï¼šå¤±çœ å¤šæ¢¦ï¼Œç•å¯’è‚¢å†·...ï¼‰"></textarea>
    </div>

    <button class="btn-submit" onclick="runDiagnosis()" id="btnRun">ğŸš€ å¼€å§‹æ™ºèƒ½è¾¨è¯</button>

    <div id="result-area">
        <div class="result-box">
            <h3>ğŸ‘… èˆŒè¯Š API è¿”å›ç»“æœ</h3>
            <pre id="res-tongue">ç­‰å¾…åˆ†æ...</pre>
        </div>
        <div class="result-box" style="border-left-color: #9C27B0; background: #fdf0fd;">
            <h3>ğŸ˜Š é¢è¯Š API è¿”å›ç»“æœ</h3>
            <pre id="res-face">ç­‰å¾…åˆ†æ...</pre>
        </div>
        <div class="result-box" style="border-left-color: #4CAF50; background: #e8f5e9;">
            <h3>ğŸ“ ç»¼åˆå»ºè®®</h3>
            <pre id="res-advice">ç­‰å¾…åˆ†æ...</pre>
        </div>
    </div>
</div>

<script>
    // æ¥å£åœ°å€é…ç½®
    const API_TONGUE = "https://www.bjbayes.com/admin/api/tongue_analysis_advance";
    const API_FACE = "https://www.bjbayes.com/admin/api/face_analysis_v2";

    // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
    function updatePreview(inputId, imgId) {
        const url = document.getElementById(inputId).value;
        const img = document.getElementById(imgId);
        if(url) {
            img.src = url;
            img.style.display = 'block';
        } else {
            img.style.display = 'none';
        }
    }

    // ç”Ÿæˆæ—¶é—´æˆ³ yyyyMMddHHmmss
    function getTimestamp() {
        const now = new Date();
        const pad = n => n < 10 ? '0' + n : n;
        return now.getFullYear() +
               pad(now.getMonth() + 1) +
               pad(now.getDate()) +
               pad(now.getHours()) +
               pad(now.getMinutes()) +
               pad(now.getSeconds());
    }

    // ç”Ÿæˆç­¾å sign = UPPER(MD5( MD5(timestamp) + appKey ))
    function generateSign(timestamp, appKey) {
        if (!appKey) return "";
        // ç¬¬ä¸€æ¬¡ MD5
        const step1 = CryptoJS.MD5(timestamp).toString();
        // ç¬¬äºŒæ¬¡ MD5 (timestampçš„MD5 + appKey)
        const step2 = CryptoJS.MD5(step1 + appKey).toString();
        // è½¬å¤§å†™
        return step2.toUpperCase();
    }

    // æ ¸å¿ƒè°ƒç”¨é€»è¾‘
    async function runDiagnosis() {
        const appId = document.getElementById('api_appid').value.trim();
        const appKey = document.getElementById('api_appkey').value.trim();
        const tongueUrl = document.getElementById('tongueUrl').value.trim();
        const faceUrl = document.getElementById('faceUrl').value.trim();
        const symptoms = document.getElementById('symptoms').value.trim();

        if (!appId || !appKey) {
            alert("âš ï¸ è¯·å…ˆåœ¨é¡¶éƒ¨å¡«å…¥æ‚¨çš„ AppID å’Œ AppKeyï¼");
            return;
        }

        // UI çŠ¶æ€æ›´æ–°
        const btn = document.getElementById('btnRun');
        btn.disabled = true;
        btn.innerText = "â³ æ­£åœ¨è¿æ¥ API åˆ†æä¸­...";
        document.getElementById('result-area').style.display = 'block';
        document.getElementById('res-tongue').innerText = "è¯·æ±‚å‘é€ä¸­...";
        document.getElementById('res-face').innerText = "è¯·æ±‚å‘é€ä¸­...";

        try {
            // å‡†å¤‡å¹¶è¡Œè¯·æ±‚
            const timestamp = getTimestamp();
            const sign = generateSign(timestamp, appKey);

            // æ„é€ è¯·æ±‚ä½“ (application/x-www-form-urlencoded)
            const createBody = (imgUrl) => {
                const params = new URLSearchParams();
                params.append('appid', appId);
                params.append('imgpath', imgUrl);
                params.append('timestamp', timestamp);
                params.append('version', '1.0');
                params.append('sign', sign);
                return params;
            };

            // å‘èµ·èˆŒè¯Šè¯·æ±‚
            const tonguePromise = tongueUrl ? fetch(API_TONGUE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: createBody(tongueUrl)
            }).then(r => r.json()).catch(e => ({ error: "èˆŒè¯Šè¯·æ±‚å¤±è´¥: " + e.message })) : Promise.resolve("æœªæä¾›èˆŒè±¡å›¾ç‰‡URL");

            // å‘èµ·é¢è¯Šè¯·æ±‚
            const facePromise = faceUrl ? fetch(API_FACE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: createBody(faceUrl)
            }).then(r => r.json()).catch(e => ({ error: "é¢è¯Šè¯·æ±‚å¤±è´¥: " + e.message })) : Promise.resolve("æœªæä¾›é¢éƒ¨å›¾ç‰‡URL");

            // ç­‰å¾…ç»“æœ
            const [tongueRes, faceRes] = await Promise.all([tonguePromise, facePromise]);

            // æ˜¾ç¤ºç»“æœ
            document.getElementById('res-tongue').innerText = JSON.stringify(tongueRes, null, 4);
            document.getElementById('res-face').innerText = JSON.stringify(faceRes, null, 4);
            
            // ç®€å•çš„ç—‡çŠ¶å›æ˜¾ï¼ˆå› ä¸ºæ²¡æœ‰æä¾›ç—‡çŠ¶APIæ¥å£ï¼‰
            document.getElementById('res-advice').innerText = "æ‚¨çš„ä¸»è¯‰ç—‡çŠ¶ï¼š" + (symptoms || "æ— ") + "\n\n(æ³¨ï¼šç—‡çŠ¶åˆ†æAPIæš‚æœªé…ç½®ï¼Œè¯·å‚è€ƒä¸Šæ–¹èˆŒé¢è¯Šçš„ JSON ç»“æœ)";

        } catch (error) {
            alert("å‘ç”Ÿç³»ç»Ÿé”™è¯¯ï¼š" + error.message);
            console.error(error);
        } finally {
            btn.disabled = false;
            btn.innerText = "ğŸš€ å¼€å§‹æ™ºèƒ½è¾¨è¯";
        }
    }
</script>

</body>
</html>