<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸­åŒ»è¾¨è¯ç»“æœæŸ¥è¯¢</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC",
          "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        margin: 0;
        padding: 24px;
        background: #f6f8fa;
        color: #1f2328;
      }
      h1 {
        margin: 0 0 16px;
        font-size: 24px;
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
        display: grid;
        gap: 16px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .card h2 {
        margin: 0 0 12px;
        font-size: 18px;
      }
      label {
        display: block;
        margin: 10px 0 6px;
        font-weight: 600;
      }
      input[type="text"],
      input[type="password"],
      textarea,
      select {
        width: 100%;
        box-sizing: border-box;
        padding: 10px;
        border: 1px solid #d0d7de;
        border-radius: 8px;
        background: #fff;
        font-size: 14px;
      }
      textarea {
        min-height: 100px;
        resize: vertical;
      }
      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
      }
      button {
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        background: #0969da;
        color: #fff;
        cursor: pointer;
        font-size: 14px;
      }
      button.secondary {
        background: #57606a;
      }
      button:disabled {
        background: #8c959f;
        cursor: not-allowed;
      }
      .result {
        margin-top: 12px;
        background: #f6f8fa;
        border-radius: 8px;
        padding: 12px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .note {
        color: #57606a;
        font-size: 12px;
        line-height: 1.6;
      }
      .tag {
        display: inline-block;
        padding: 2px 8px;
        background: #ddf4ff;
        color: #0969da;
        border-radius: 999px;
        font-size: 12px;
      }
      .divider {
        height: 1px;
        background: #eaeef2;
        margin: 16px 0;
      }
    </style>
</head>
<body>
<div class="container">
      <h1>ä¸­åŒ»èˆŒè¯Š/é¢è¯Š/ä½“è´¨è¾¨è¯ - å‰ç«¯æ¼”ç¤º</h1>

      <div class="card">
        <h2>âœ… ä½¿ç”¨è¯´æ˜</h2>
        <p class="note" id="originNotice"></p>
        <p class="note" id="originWarning" style="color: #b42318;"></p>
      </div>

      <div class="card">
        <h2>ğŸ§¾ ä½“è´¨è¾¨è¯ï¼ˆè‡ªå»º APIï¼‰</h2>
        <label>ç—‡çŠ¶æè¿°ï¼ˆä¸­æ–‡ï¼‰</label>
        <textarea
          id="symptomsText"
          placeholder="ä¾‹å¦‚ï¼šæœ€è¿‘å®¹æ˜“ç–²åŠ³ã€è¯´è¯å£°éŸ³ä½ã€ç¨å¾®æ´»åŠ¨å°±å‡ºæ±—..."
        ></textarea>
        <div class="row">
          <div>
            <label>å¹´é¾„ï¼ˆå¯é€‰ï¼‰</label>
            <input id="metaAge" type="text" placeholder="28" />
          </div>
          <div>
            <label>æ€§åˆ«ï¼ˆå¯é€‰ï¼‰</label>
            <select id="metaSex">
              <option value="">ä¸å¡«å†™</option>
              <option value="M">ç”·</option>
              <option value="F">å¥³</option>
            </select>
          </div>
          <div>
            <label>åœ°åŒºï¼ˆå¯é€‰ï¼‰</label>
            <input id="metaRegion" type="text" placeholder="CN" />
          </div>
        </div>
        <div class="row" style="margin-top: 12px;">
          <button id="runBtn" onclick="runConstitution()">è·å–ä½“è´¨è¾¨è¯ç»“æœ</button>
          <button class="secondary" onclick="clearResult('constitutionResult')">æ¸…ç©ºç»“æœ</button>
          <button class="secondary" onclick="testHealth()">æµ‹è¯• /health</button>
        </div>
        <div id="constitutionResult" class="result">ç­‰å¾…è¯·æ±‚...</div>
    </div>

      <div class="card">
        <h2>ğŸ§¾ ä½“è´¨è¾¨è¯ï¼ˆè‡ªå»º APIï¼‰</h2>
        <label>ç—‡çŠ¶æè¿°ï¼ˆä¸­æ–‡ï¼‰</label>
        <textarea
          id="symptomsText"
          placeholder="ä¾‹å¦‚ï¼šæœ€è¿‘å®¹æ˜“ç–²åŠ³ã€è¯´è¯å£°éŸ³ä½ã€ç¨å¾®æ´»åŠ¨å°±å‡ºæ±—..."
        ></textarea>
        <div class="row">
          <div>
            <label>å¹´é¾„ï¼ˆå¯é€‰ï¼‰</label>
            <input id="metaAge" type="text" placeholder="28" />
          </div>
          <div>
            <label>æ€§åˆ«ï¼ˆå¯é€‰ï¼‰</label>
            <select id="metaSex">
              <option value="">ä¸å¡«å†™</option>
              <option value="M">ç”·</option>
              <option value="F">å¥³</option>
            </select>
    </div>
          <div>
            <label>åœ°åŒºï¼ˆå¯é€‰ï¼‰</label>
            <input id="metaRegion" type="text" placeholder="CN" />
    </div>
        </div>
        <div class="row" style="margin-top: 12px;">
          <button onclick="runConstitution()">è°ƒç”¨ä½“è´¨è¾¨è¯ API</button>
          <button class="secondary" onclick="clearResult('constitutionResult')">æ¸…ç©ºç»“æœ</button>
        </div>
        <div id="constitutionResult" class="result">ç­‰å¾…è¯·æ±‚...</div>
      </div>

      <div class="card">
        <h2>ğŸš€ æ“ä½œæç¤º</h2>
        <p class="note">
          å½“å‰é¡µé¢ä»…å¯ç”¨ä½“è´¨è¾¨è¯æ¥å£ã€‚èˆŒè¯Š/é¢è¯Šå°šæœªé…ç½® appid/appKeyï¼Œå› æ­¤æš‚ä¸æä¾›ã€‚
        </p>
        </div>

      <div class="card">
        <h2>å…è´£å£°æ˜</h2>
        <p class="note">
          æœ¬é¡µé¢ä»…ç”¨äºä½“è´¨å€¾å‘æ€§åˆ†ææ¼”ç¤ºï¼Œä¸æ„æˆåŒ»ç–—è¯Šæ–­ã€‚ä¸æä¾›å¤„æ–¹æˆ–ç”¨è¯å»ºè®®ã€‚å¦‚æœ‰å¥åº·é—®é¢˜è¯·å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿæˆ–ä¸­åŒ»å¸ˆã€‚
        </p>
    </div>
</div>

<script>
      const CONFIG = {
        CONSTITUTION_BASE_URL: window.location.origin,
        CONSTITUTION_API_KEY: "64ded59e680e68c52c91c17e97a953b7",
      };

      const originNotice = document.getElementById("originNotice");
      const originWarning = document.getElementById("originWarning");
      const runBtn = document.getElementById("runBtn");

      originNotice.textContent =
        "å½“å‰é¡µé¢æ¥æºï¼š" + window.location.origin + "ï¼ˆæ¨èé€šè¿‡ /ui åŒåŸŸè®¿é—®ï¼‰";

      if (window.location.protocol === "file:") {
        originWarning.textContent =
          "ä½ æ­£åœ¨ä½¿ç”¨ file:// æ‰“å¼€é¡µé¢ï¼Œæµè§ˆå™¨ä¼šé˜»æ­¢è·¨åŸŸè¯·æ±‚ã€‚è¯·ä½¿ç”¨ï¼šhttps://tcm-constitution-api.onrender.com/ui";
        if (runBtn) runBtn.disabled = true;
      }

      async function runConstitution() {
        const baseUrl = CONFIG.CONSTITUTION_BASE_URL;
        const apiKey = CONFIG.CONSTITUTION_API_KEY;
        const text = document.getElementById("symptomsText").value.trim();

        if (!baseUrl) {
          renderResult("constitutionResult", { error: "é…ç½®ç¼ºå¤±ï¼Œè¯·è”ç³»ç®¡ç†å‘˜" });
          return;
        }
        if (!text) {
          renderResult("constitutionResult", { error: "è¯·å¡«å†™ç—‡çŠ¶æè¿°" });
            return;
        }

        const meta = {};
        const age = document.getElementById("metaAge").value.trim();
        const sex = document.getElementById("metaSex").value.trim();
        const region = document.getElementById("metaRegion").value.trim();

        if (age) meta.age = Number(age);
        if (sex) meta.sex = sex;
        if (region) meta.region = region;

        const payload = { text, meta: Object.keys(meta).length ? meta : undefined };
        const url = baseUrl.replace(/\/+$/, "") + "/v1/constitution/estimate";

        const headers = { "Content-Type": "application/json" };
        if (apiKey) headers.Authorization = "Bearer " + apiKey;

        await postJson(url, payload, headers, "constitutionResult");
      }

      async function testHealth() {
        const baseUrl = CONFIG.CONSTITUTION_BASE_URL;
        if (!baseUrl) {
          renderResult("constitutionResult", { error: "é…ç½®ç¼ºå¤±ï¼Œè¯·è”ç³»ç®¡ç†å‘˜" });
          return;
        }
        const url = baseUrl.replace(/\/+$/, "") + "/health";
        await postJson(url, null, {}, "constitutionResult", "GET");
      }

      function clearResult(id) {
        document.getElementById(id).textContent = "ç­‰å¾…è¯·æ±‚...";
      }

      async function postJson(url, payload, headers, resultId, method = "POST") {
        try {
          renderResult(resultId, { loading: true });
          const res = await fetch(url, {
            method,
            headers,
            body: payload ? JSON.stringify(payload) : undefined,
          });
          const text = await res.text();
          renderResult(resultId, safeJson(text));
        } catch (err) {
          renderResult(resultId, { error: String(err) });
        }
      }

      function renderResult(id, data) {
        const el = document.getElementById(id);
        if (data && data.loading) {
          el.textContent = "è¯·æ±‚ä¸­...";
          return;
        }
        el.textContent = JSON.stringify(data, null, 2);
      }

      function safeJson(text) {
        try {
          return JSON.parse(text);
        } catch (e) {
          return { raw: text };
        }
    }
</script>
</body>
</html>
